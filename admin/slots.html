<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FCBS Admin - Slot Management</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .create-slot-container {
      display: none;
      margin-bottom: 20px;
    }
    .create-slot-container.show {
      display: block;
    }
    .status-available {
      color: #10b981;
      font-weight: 500;
    }
    .status-in-review {
      color: #f59e0b;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo-section">
      <div class="logo">
        <div class="logo-icon">FCBS</div>
        <div class="logo-text">Football Court Booking System</div>
      </div>
    </div>
    
    <ul class="nav-menu">
      <li class="nav-item">
        <a href="slots.html" class="nav-link active">Slot Management</a>
      </li>
      <li class="nav-item">
        <a href="requests.html" class="nav-link">View Requests</a>
      </li>
      <li class="nav-item">
        <a href="accepted.html" class="nav-link">Accepted Requests</a>
      </li>
      <li class="nav-item">
        <a href="notifications.html" class="nav-link">Send Notifications</a>
      </li>
    </ul>
    
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </div>

  <div class="main-content">
    <div class="page-header">
      <h1>Slot Management</h1>
      <p>Create and manage time slots for the football court</p>
    </div>

    <button id="showCreateFormBtn" class="btn btn-primary" style="margin-bottom: 20px;">
      <i class="fas fa-plus"></i> Create New Slot
    </button>

    <div id="create-slot-container" class="create-slot-container section">
      <h2 class="section-title">Create New Slot</h2>
      <form id="create-form" class="form-grid">
        <div class="form-group">
          <label for="create-date">Date</label>
          <input type="date" id="create-date" class="form-input" required />
        </div>
        <div class="form-group">
          <label for="create-start">Start Time</label>
          <input type="time" id="create-start" class="form-input" required />
        </div>
        <div class="form-group">
          <label for="create-end">End Time</label>
          <input type="time" id="create-end" class="form-input" required />
        </div>
        <div class="form-group">
          <button type="submit" class="btn btn-primary">Create Slot</button>
          <button type="button" class="btn btn-secondary" onclick="hideCreateForm()">Cancel</button>
        </div>
      </form>
    </div>

    <div class="section">
      <h2 class="section-title">All Slots</h2>
      
      <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading slots...</p>
      </div>

      <div id="empty" class="empty" style="display: none;">
        <p>No slots found. Create your first slot above.</p>
      </div>

      <div id="table-container" class="table-container">
        <table id="slots-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Start Time</th>
              <th>End Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Slot</h3>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      
      <form id="edit-form" class="modal-form">
        <input type="hidden" id="edit-id" />
        <div class="form-group">
          <label for="edit-date">Date</label>
          <input type="date" id="edit-date" class="form-input" required />
        </div>
        <div class="form-group">
          <label for="edit-start">Start Time</label>
          <input type="time" id="edit-start" class="form-input" required />
        </div>
        <div class="form-group">
          <label for="edit-end">End Time</label>
          <input type="time" id="edit-end" class="form-input" required />
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-success">Update</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://uawgdwbkpdazmqqyupwx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhd2dkd2JrcGRhem1xcXl1cHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwNDQxNDksImV4cCI6MjA2NjYyMDE0OX0.HipuiHPZkoUGN52t27ZNKx6vkwNmzLPJ0m7YyRRMvNY';
    const token = localStorage.getItem('supabase_token');

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      global: {
        headers: {
          Authorization: token ? `Bearer ${token}` : undefined
        }
      }
    });

    const tableBody = document.querySelector('#slots-table tbody');
    const showCreateFormBtn = document.getElementById('showCreateFormBtn');
    const createSlotContainer = document.getElementById('create-slot-container');

    // Toggle create slot form visibility
    function showCreateForm() {
      createSlotContainer.classList.add('show');
    }

    function hideCreateForm() {
      createSlotContainer.classList.remove('show');
    }

    showCreateFormBtn.addEventListener('click', showCreateForm);

    // Check if slot is booked
    async function isSlotBooked(slotId) {
      const { data, error } = await supabase
        .from('bookings')
        .select('id')
        .eq('slot_id', slotId)
        .maybeSingle();

      if (error) {
        console.error('Error checking booking status:', error);
        return false;
      }

      return !!data;
    }

    // Fetch and render slots
    async function loadSlots() {
      const { data: slots, error } = await supabase.from('slots').select('*').order('id', { ascending: true });
      if (error) {
        alert('Error fetching slots: ' + error.message);
        return;
      }

      tableBody.innerHTML = '';

      for (const slot of slots) {
        const booked = await isSlotBooked(slot.id);
        const status = booked ? 'In Review' : 'Available';
        const statusClass = booked ? 'status-in-review' : 'status-available';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${slot.id}</td>
          <td>${slot.date}</td>
          <td>${slot.start_time}</td>
          <td>${slot.end_time}</td>
          <td class="${statusClass}">${status}</td>
          <td>
            <button 
              onclick="viewSlot(${slot.id})" 
              style="
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 6px;
                padding: 8px 12px;
                margin: 2px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 5px;
              "
            >
              <i class="fas fa-eye" style="font-size: 12px;"></i>
              View
            </button>
            <button 
              onclick="showEditForm(${slot.id}, '${slot.date}', '${slot.start_time}', '${slot.end_time}')" 
              style="
                background: #10b981;
                color: white;
                border: none;
                border-radius: 6px;
                padding: 8px 12px;
                margin: 2px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 5px;
              "
            >
              <i class="fas fa-edit" style="font-size: 12px;"></i>
              Edit
            </button>
            <button 
              onclick="deleteSlot(${slot.id})" 
              style="
                background: #ef4444;
                color: white;
                border: none;
                border-radius: 6px;
                padding: 8px 12px;
                margin: 2px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 5px;
              "
            >
              <i class="fas fa-trash" style="font-size: 12px;"></i>
              Delete
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      }
    }

    function closeModal() {
      document.getElementById('edit-modal').style.display = 'none';
    }

    // Create slot
    document.getElementById('create-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const date = document.getElementById('create-date').value;
      const start = document.getElementById('create-start').value;
      const end = document.getElementById('create-end').value;

      const { error } = await supabase.from('slots').insert([{ date, start_time: start, end_time: end }]);
      if (error) {
        alert('Error creating slot: ' + error.message);
      } else {
        alert('Slot created!');
        e.target.reset();
        hideCreateForm();
        loadSlots();
      }
    });

    // Show edit form
    function showEditForm(id, date, start_time, end_time) {
      document.getElementById('edit-id').value = id;
      document.getElementById('edit-date').value = date;
      document.getElementById('edit-start').value = start_time;
      document.getElementById('edit-end').value = end_time;
      document.getElementById('edit-modal').style.display = 'block';
    }

    // Edit slot
    document.getElementById('edit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('edit-id').value;
      const date = document.getElementById('edit-date').value;
      const start = document.getElementById('edit-start').value;
      const end = document.getElementById('edit-end').value;

      const { error } = await supabase.from('slots').update({ date, start_time: start, end_time: end }).eq('id', id);
      if (error) {
        alert('Error updating slot: ' + error.message);
      } else {
        alert('Slot updated!');
        document.getElementById('edit-modal').style.display = 'none';
        loadSlots();
      }
    });

    // Delete slot
    async function deleteSlot(id) {
      if (!confirm('Are you sure you want to delete this slot?')) return;
      const { error } = await supabase.from('slots').delete().eq('id', id);
      if (error) {
        alert('Error deleting slot: ' + error.message);
      } else {
        alert('Slot deleted!');
        loadSlots();
      }
    }

    // View slot (simple alert)
    async function viewSlot(id) {
      const { data, error } = await supabase.from('slots').select('*').eq('id', id).single();
      if (error) {
        alert('Error fetching slot: ' + error.message);
      } else {
        alert(`Slot ID: ${data.id}\nDate: ${data.date}\nStart: ${data.start_time}\nEnd: ${data.end_time}`);
      }
    }

    document.getElementById('logoutBtn').addEventListener('click', logout);
    async function logout() {
      try {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        localStorage.removeItem('supabase_token');
        window.location.href = '../index.html';
      } catch (error) {
        console.error('Error logging out:', error);
        alert('Failed to logout. Please try again.');
      }
    }

    // Initial load
    loadSlots();
  </script>
</body>
</html>